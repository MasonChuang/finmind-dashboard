<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸‚å ´æˆ°æƒ…å®¤ - FinMind Antigravity</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      background-color: #ffffff;
    }

    .navbar-brand {
      font-weight: 600;
      color: #0d6efd !important;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      position: relative;
      height: 400px;
      margin-bottom: 20px;
    }

    .stat-card {
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .positive {
      color: #dc3545;
    }

    .negative {
      color: #198754;
    }

    .table-sm td,
    .table-sm th {
      padding: 0.5rem;
    }

    .bar-chart-container {
      position: relative;
      height: 400px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light fixed-top mb-4">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-graph-up-arrow"></i>
        <div>
          <div>å¸‚å ´æˆ°æƒ…å®¤</div>
          <div style="font-size: 0.75rem; font-weight: 400; color: #6c757d;">Market War Room</div>
        </div>
      </a>
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted small d-none d-md-block">æ›´æ–°æ™‚é–“: <span id="updateTime">è¼‰å…¥ä¸­...</span></span>
        <a href="index.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Back</a>
      </div>
    </div>
  </nav>
  <div style="height: 80px;"></div>

  <div class="container-fluid mt-4">
    <!-- æ•´åˆåœ–è¡¨ï¼šåŠ æ¬ŠæŒ‡æ•¸ + é¨°è½ç·š (é›™Yè»¸) -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ“Š åŠ æ¬ŠæŒ‡æ•¸ & é¨°è½ç·šï¼ˆè¿‘ 120 æ—¥ï¼‰
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="combinedChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¸‚å ´æ¦‚æ³çµ±è¨ˆå¡ç‰‡ -->
    <div class="row mt-4 mb-4">
      <div class="col-md-3">
        <div class="card stat-card border-danger">
          <div class="card-body text-center">
            <h6 class="text-muted">æ¼²åœå®¶æ•¸</h6>
            <div class="display-4 fw-bold text-danger" id="limitUpCount">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card border-success">
          <div class="card-body text-center">
            <h6 class="text-muted">è·Œåœå®¶æ•¸</h6>
            <div class="display-4 fw-bold text-success" id="limitDownCount">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card border-danger">
          <div class="card-body text-center">
            <h6 class="text-muted">ä¸Šæ¼²å®¶æ•¸</h6>
            <div class="display-4 fw-bold text-danger" id="upCount">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card border-success">
          <div class="card-body text-center">
            <h6 class="text-muted">ä¸‹è·Œå®¶æ•¸</h6>
            <div class="display-4 fw-bold text-success" id="downCount">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¿¡ç”¨äº¤æ˜“ (èè³‡èåˆ¸) -->
    <div class="row mt-4 mb-4">
      <div class="col-12">
        <h5 class="fw-bold text-muted ps-2 border-start border-4 border-primary mb-3">ä¿¡ç”¨äº¤æ˜“ (Credit Transactions)</h5>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <h6 class="text-muted">èè³‡é¤˜é¡ (å„„)</h6>
            <div class="display-6 fw-bold text-primary" id="marginBalance">-</div>
            <div class="small fw-bold" id="marginChange">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <h6 class="text-muted">èåˆ¸é¤˜é¡ (è¬å¼µ)</h6>
            <div class="display-6 fw-bold text-success" id="shortBalance">-</div>
            <div class="small fw-bold" id="shortChange">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <h6 class="text-muted">è³‡åˆ¸æ—¥æœŸ</h6>
            <div class="display-6 fw-bold text-secondary" id="creditDate">-</div>
            <div class="small text-muted">æœ€æ–°è³‡æ–™</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¢æ¥­è³‡é‡‘æµå‘ (æŸ±ç‹€åœ–) -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ’° ç”¢æ¥­è³‡é‡‘æµå‘ï¼ˆå‰ 10 å¤§ï¼‰
          </div>
          <div class="card-body">
            <div class="bar-chart-container">
              <canvas id="sectorFlowChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ³•äººå‹•å‘ -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ¦ æ³•äººå–®æ—¥è²·è¶… Top 5
          </div>
          <div class="card-body">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>æ’å</th>
                  <th>è‚¡ç¥¨</th>
                  <th class="text-end">è²·è¶…å¼µæ•¸</th>
                </tr>
              </thead>
              <tbody id="institutionalDailyTable">
                <tr>
                  <td colspan="3" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ“ˆ æ³•äºº10æ—¥ç´¯ç©è²·è¶… Top 5
          </div>
          <div class="card-body">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>æ’å</th>
                  <th>è‚¡ç¥¨</th>
                  <th class="text-end">ç´¯ç©å¼µæ•¸</th>
                </tr>
              </thead>
              <tbody id="institutional10dTable">
                <tr>
                  <td colspan="3" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- å·¨é¯¨æ´»å‹• -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ‹ å·¨é¯¨1é€±æŒè‚¡å¢åŠ  Top 5
          </div>
          <div class="card-body">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>æ’å</th>
                  <th>è‚¡ç¥¨</th>
                  <th class="text-end">æŒè‚¡å¢åŠ (%)</th>
                </tr>
              </thead>
              <tbody id="whaleWeekTable">
                <tr>
                  <td colspan="3" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ¦ˆ å·¨é¯¨2é€±æŒçºŒç´¯ç© Top 5
          </div>
          <div class="card-body">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>æ’å</th>
                  <th>è‚¡ç¥¨</th>
                  <th class="text-end">æŒè‚¡å¢åŠ (%)</th>
                </tr>
              </thead>
              <tbody id="whaleBiweekTable">
                <tr>
                  <td colspan="3" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- æŠ€è¡“è¨Šè™Ÿ -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ”¥ 60æ—¥æ–°é«˜ Top 10
          </div>
          <div class="card-body">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>æ’å</th>
                  <th>è‚¡ç¥¨</th>
                  <th class="text-end">è‚¡åƒ¹</th>
                </tr>
              </thead>
              <tbody id="high60dTable">
                <tr>
                  <td colspan="3" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-light fw-bold">
            ğŸ“Š å­£ç·šçªç ´ Top 10
          </div>
          <div class="card-body">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>æ’å</th>
                  <th>è‚¡ç¥¨</th>
                  <th class="text-end">è‚¡åƒ¹</th>
                  <th class="text-end">å­£ç·š</th>
                </tr>
              </thead>
              <tbody id="ma60BreakoutTable">
                <tr>
                  <td colspan="4" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- è¿”å›é¦–é æŒ‰éˆ• -->
    <div class="row mt-4 mb-4">
      <div class="col-12 text-center">
        <a href="index.html" class="btn btn-primary btn-lg">
          ğŸ  è¿”å›é¦–é 
        </a>
      </div>
    </div>
  </div>

  <script>
    // é¡¯ç¤ºç•¶å‰æ™‚é–“
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      document.getElementById('updateTime').textContent = timeStr;
    }

    updateTime();
    setInterval(updateTime, 1000);

    // è¼‰å…¥è³‡æ–™ä¸¦ç¹ªè£½åœ–è¡¨
    async function loadData() {
      try {
        const response = await fetch('data/market_war_room.json');
        if (!response.ok) {
          throw new Error('ç„¡æ³•è¼‰å…¥è³‡æ–™');
        }
        const data = await response.json();
        renderCharts(data);
      } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
      }
    }

    function renderCharts(data) {
      // æ›´æ–°çµ±è¨ˆå¡ç‰‡ (ä½¿ç”¨æœ€æ–°ä¸€å¤©çš„è³‡æ–™)
      if (data.breadth && data.breadth.length > 0) {
        const latest = data.breadth[data.breadth.length - 1];
        document.getElementById('limitUpCount').textContent = latest.limit_up || 0;
        document.getElementById('limitDownCount').textContent = latest.limit_down || 0;
        document.getElementById('upCount').textContent = latest.up || 0;
        document.getElementById('downCount').textContent = latest.down || 0;
      }

      // æ›´æ–°ä¿¡ç”¨äº¤æ˜“æ•¸æ“š
      if (data.credit) {
        // èè³‡é¤˜é¡ (å„„)
        const marginVal = data.credit.margin_balance || 0;
        const marginChgVal = data.credit.margin_change || 0;
        const marginBal = (marginVal / 100000000).toFixed(2);
        const marginChg = (Math.abs(marginChgVal) / 100000000).toFixed(2);

        document.getElementById('marginBalance').textContent = marginBal;
        const marginChgEl = document.getElementById('marginChange');
        if (marginChgVal > 0) {
          marginChgEl.innerHTML = `<span class="text-danger">â–² ${marginChg}</span>`;
        } else if (marginChgVal < 0) {
          marginChgEl.innerHTML = `<span class="text-success">â–¼ ${marginChg}</span>`;
        } else {
          marginChgEl.textContent = '-';
        }

        // èåˆ¸é¤˜é¡ (è¬å¼µ)
        const shortVal = data.credit.short_balance || 0;
        const shortChgVal = data.credit.short_change || 0;
        const shortBal = (shortVal / 1000).toFixed(0);
        const shortChg = (Math.abs(shortChgVal) / 1000).toFixed(0);

        document.getElementById('shortBalance').textContent = shortBal;
        const shortChgEl = document.getElementById('shortChange');
        if (shortChgVal > 0) {
          shortChgEl.innerHTML = `<span class="text-danger">â–² ${shortChg}</span>`; // èåˆ¸å¢åŠ ç‚ºç´…è‰²? é€šå¸¸å¢åŠ ä»£è¡¨åç©º? ä¸, å°è‚¡æ…£ä¾‹ç´…è‰²ä»£è¡¨æ•¸å€¼å¢åŠ 
        } else if (shortChgVal < 0) {
          shortChgEl.innerHTML = `<span class="text-success">â–¼ ${shortChg}</span>`;
        } else {
          shortChgEl.textContent = '-';
        }

        // æ—¥æœŸ
        document.getElementById('creditDate').textContent = data.credit.date || '-';
      }

      // ç¹ªè£½æ•´åˆåœ–è¡¨ï¼ˆåŠ æ¬ŠæŒ‡æ•¸ + é¨°è½ç·šï¼Œé›™Yè»¸ï¼‰
      const dates = data.taiex.map(d => d.date);
      const taiexClose = data.taiex.map(d => d.close);

      const adlMap = new Map(data.breadth.map(d => [d.date, d.adl]));
      const adlValues = dates.map(date => adlMap.get(date) || null);

      new Chart(document.getElementById('combinedChart'), {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'åŠ æ¬ŠæŒ‡æ•¸',
              data: taiexClose,
              yAxisID: 'y-taiex',
              borderColor: 'rgb(220, 53, 69)',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              tension: 0.1,
              fill: false,
              borderWidth: 2
            },
            {
              label: 'é¨°è½ç·š(ADL)',
              data: adlValues,
              yAxisID: 'y-adl',
              borderColor: 'rgb(13, 110, 253)',
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              tension: 0.1,
              fill: false,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 10
              }
            },
            'y-taiex': {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'åŠ æ¬ŠæŒ‡æ•¸'
              }
            },
            'y-adl': {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: 'é¨°è½ç·š'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });

      // ç¹ªè£½ç”¢æ¥­è³‡é‡‘æµå‘æŸ±ç‹€åœ–
      if (data.sectors && data.sectors.length > 0) {
        const sectorLabels = data.sectors.map(s => s.industry_category);
        const sectorFlows = data.sectors.map(s => s.flow / 100000000); // è½‰æ›ç‚ºå„„
        const sectorColors = sectorFlows.map(f => f > 0 ? 'rgba(220, 53, 69, 0.8)' : 'rgba(25, 135, 84, 0.8)');

        new Chart(document.getElementById('sectorFlowChart'), {
          type: 'bar',
          data: {
            labels: sectorLabels,
            datasets: [{
              label: 'è³‡é‡‘æµå‘ï¼ˆå„„ï¼‰',
              data: sectorFlows,
              backgroundColor: sectorColors,
              borderColor: sectorColors.map(c => c.replace('0.8', '1')),
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'è³‡é‡‘æµå‘ï¼ˆå„„å…ƒï¼‰'
                }
              }
            }
          }
        });
      }

      // æ¸²æŸ“æ³•äººå‹•å‘ - å–®æ—¥è²·è¶…
      const institutionalDailyTable = document.getElementById('institutionalDailyTable');
      if (data.institutional && data.institutional.daily_top5 && data.institutional.daily_top5.length > 0) {
        institutionalDailyTable.innerHTML = data.institutional.daily_top5.map((item, index) => {
          const shares = (item.net_buy / 1000).toFixed(0);
          return `
            <tr>
              <td>${index + 1}</td>
              <td><span class="fw-bold">${item.stock_id}</span> ${item.stock_name}</td>
              <td class="text-end font-monospace positive">${shares}</td>
            </tr>
          `;
        }).join('');
      } else {
        institutionalDailyTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
      }

      // æ¸²æŸ“æ³•äººå‹•å‘ - 10æ—¥ç´¯ç©
      const institutional10dTable = document.getElementById('institutional10dTable');
      if (data.institutional && data.institutional.accumulate_10d_top5 && data.institutional.accumulate_10d_top5.length > 0) {
        institutional10dTable.innerHTML = data.institutional.accumulate_10d_top5.map((item, index) => {
          const shares = (item.net_buy_10d / 1000).toFixed(0);
          return `
            <tr>
              <td>${index + 1}</td>
              <td><span class="fw-bold">${item.stock_id}</span> ${item.stock_name}</td>
              <td class="text-end font-monospace positive">${shares}</td>
            </tr>
          `;
        }).join('');
      } else {
        institutional10dTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
      }

      // æ¸²æŸ“å·¨é¯¨æ´»å‹• - 1é€±å¢åŠ 
      const whaleWeekTable = document.getElementById('whaleWeekTable');
      if (data.whale && data.whale.week_increase_top5 && data.whale.week_increase_top5.length > 0) {
        whaleWeekTable.innerHTML = data.whale.week_increase_top5.map((item, index) => {
          return `
            <tr>
              <td>${index + 1}</td>
              <td><span class="fw-bold">${item.stock_id}</span> ${item.stock_name}</td>
              <td class="text-end font-monospace positive">${item.whale_change.toFixed(2)}</td>
            </tr>
          `;
        }).join('');
      } else {
        whaleWeekTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
      }

      // æ¸²æŸ“å·¨é¯¨æ´»å‹• - 2é€±ç´¯ç©
      const whaleBiweekTable = document.getElementById('whaleBiweekTable');
      if (data.whale && data.whale.biweek_accumulate_top5 && data.whale.biweek_accumulate_top5.length > 0) {
        whaleBiweekTable.innerHTML = data.whale.biweek_accumulate_top5.map((item, index) => {
          return `
            <tr>
              <td>${index + 1}</td>
              <td><span class="fw-bold">${item.stock_id}</span> ${item.stock_name}</td>
              <td class="text-end font-monospace positive">${item.whale_change_2w.toFixed(2)}</td>
            </tr>
          `;
        }).join('');
      } else {
        whaleBiweekTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
      }

      // æ¸²æŸ“æŠ€è¡“è¨Šè™Ÿ - 60æ—¥æ–°é«˜
      const high60dTable = document.getElementById('high60dTable');
      if (data.technical && data.technical.high_60d && data.technical.high_60d.length > 0) {
        high60dTable.innerHTML = data.technical.high_60d.map((item, index) => {
          return `
            <tr>
              <td>${index + 1}</td>
              <td><span class="fw-bold">${item.stock_id}</span> ${item.stock_name}</td>
              <td class="text-end font-monospace">${item.price.toFixed(2)}</td>
            </tr>
          `;
        }).join('');
      } else {
        high60dTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
      }

      // æ¸²æŸ“æŠ€è¡“è¨Šè™Ÿ - å­£ç·šçªç ´
      const ma60BreakoutTable = document.getElementById('ma60BreakoutTable');
      if (data.technical && data.technical.ma60_breakout && data.technical.ma60_breakout.length > 0) {
        ma60BreakoutTable.innerHTML = data.technical.ma60_breakout.map((item, index) => {
          return `
            <tr>
              <td>${index + 1}</td>
              <td><span class="fw-bold">${item.stock_id}</span> ${item.stock_name}</td>
              <td class="text-end font-monospace">${item.price.toFixed(2)}</td>
              <td class="text-end font-monospace text-muted">${item.ma60.toFixed(2)}</td>
            </tr>
          `;
        }).join('');
      } else {
        ma60BreakoutTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
      }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadData();
  </script>
</body>

</html>